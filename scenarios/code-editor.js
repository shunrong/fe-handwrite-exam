/**
 * Âú∫ÊôØÈ¢ò11: ‰ª£Á†ÅÁºñËæëÂô®ÁªÑ‰ª∂ÂÆûÁé∞
 * 
 * ‰∏öÂä°Âú∫ÊôØÔºö
 * - Âú®Á∫ø‰ª£Á†ÅÁºñÁ®ãÂπ≥Âè∞ÈúÄË¶Å‰ª£Á†ÅÁºñËæëÂäüËÉΩ
 * - ÊäÄÊúØÊñáÊ°£ÁΩëÁ´ôÈúÄË¶Å‰ª£Á†ÅÂ±ïÁ§∫ÂíåÁºñËæë
 * - ÈÖçÁΩÆÊñá‰ª∂Âú®Á∫øÁºñËæëÁ≥ªÁªü
 * 
 * ËÄÉÂØüÁÇπÔºö
 * - ÊñáÊú¨Â§ÑÁêÜÂíåÂÖâÊ†áÊìç‰Ωú
 * - ËØ≠Ê≥ïÈ´ò‰∫ÆÂíå‰ª£Á†ÅËß£Êûê
 * - ÈîÆÁõòÂø´Êç∑ÈîÆÂíåÁºñËæë‰ΩìÈ™å
 * - ‰ª£Á†ÅÊ†ºÂºèÂåñÂíåÊô∫ËÉΩÊèêÁ§∫
 * - ÊÄßËÉΩ‰ºòÂåñÔºàÂ§ßÊñá‰ª∂Â§ÑÁêÜÔºâ
 */

// 1. Âü∫Á°Ä‰ª£Á†ÅÁºñËæëÂô®
class CodeEditor {
  constructor(container, options = {}) {
    this.container = typeof container === 'string' 
      ? document.querySelector(container) 
      : container;
    
    this.options = {
      language: 'javascript',        // ÁºñÁ®ãËØ≠Ë®Ä
      theme: 'dark',                // ‰∏ªÈ¢ò
      fontSize: 14,                 // Â≠ó‰ΩìÂ§ßÂ∞è
      tabSize: 2,                   // Áº©ËøõÂ§ßÂ∞è
      lineNumbers: true,            // ÊòæÁ§∫Ë°åÂè∑
      wordWrap: true,               // Ëá™Âä®Êç¢Ë°å
      autoIndent: true,             // Ëá™Âä®Áº©Ëøõ
      bracketMatching: true,        // Êã¨Âè∑ÂåπÈÖç
      autoComplete: true,           // Ëá™Âä®Ë°•ÂÖ®
      minimap: false,               // Â∞èÂú∞Âõæ
      readOnly: false,              // Âè™ËØªÊ®°Âºè
      ...options
    };
    
    this.state = {
      content: '',                  // ÁºñËæëÂô®ÂÜÖÂÆπ
      cursor: { line: 0, column: 0 }, // ÂÖâÊ†á‰ΩçÁΩÆ
      selection: null,              // ÈÄâ‰∏≠ÂÜÖÂÆπ
      history: [],                  // Êìç‰ΩúÂéÜÂè≤
      historyIndex: -1,             // ÂéÜÂè≤Á¥¢Âºï
      language: this.options.language
    };
    
    this.callbacks = {
      onChange: options.onChange || (() => {}),
      onCursorChange: options.onCursorChange || (() => {}),
      onSelectionChange: options.onSelectionChange || (() => {}),
      onSave: options.onSave || (() => {})
    };
    
    this.elements = {};
    this.highlighter = new SyntaxHighlighter();
    this.autoComplete = new AutoComplete();
    
    this.init();
  }
  
  init() {
    this.createElements();
    this.bindEvents();
    this.setupSyntaxHighlighting();
    this.setupAutoComplete();
  }
  
  // ÂàõÂª∫ÁºñËæëÂô®ÂÖÉÁ¥†
  createElements() {
    this.container.innerHTML = `
      <div class="code-editor ${this.options.theme}">
        <div class="editor-header">
          <div class="editor-tabs">
            <div class="editor-tab active">
              <span class="tab-language">${this.options.language}</span>
              <span class="tab-close">√ó</span>
            </div>
          </div>
          <div class="editor-actions">
            <button class="editor-btn" id="format-btn" title="Ê†ºÂºèÂåñ‰ª£Á†Å">üé®</button>
            <button class="editor-btn" id="save-btn" title="‰øùÂ≠ò (Ctrl+S)">üíæ</button>
            <button class="editor-btn" id="settings-btn" title="ËÆæÁΩÆ">‚öôÔ∏è</button>
          </div>
        </div>
        
        <div class="editor-body">
          ${this.options.lineNumbers ? '<div class="line-numbers"></div>' : ''}
          <div class="editor-content">
            <div class="editor-lines"></div>
            <textarea 
              class="editor-textarea" 
              spellcheck="false"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="off"
              ${this.options.readOnly ? 'readonly' : ''}
            ></textarea>
            <div class="editor-cursor"></div>
            <div class="editor-selection"></div>
          </div>
        </div>
        
        <div class="editor-footer">
          <div class="editor-status">
            <span class="cursor-position">Á¨¨ 1 Ë°åÔºåÁ¨¨ 1 Âàó</span>
            <span class="editor-language">${this.options.language}</span>
            <span class="editor-encoding">UTF-8</span>
          </div>
        </div>
        
        <div class="autocomplete-popup" style="display: none;">
          <div class="autocomplete-list"></div>
        </div>
      </div>
    `;
    
    // ÁºìÂ≠òDOMÂÖÉÁ¥†
    this.elements = {
      textarea: this.container.querySelector('.editor-textarea'),
      lines: this.container.querySelector('.editor-lines'),
      lineNumbers: this.container.querySelector('.line-numbers'),
      cursor: this.container.querySelector('.editor-cursor'),
      selection: this.container.querySelector('.editor-selection'),
      statusPosition: this.container.querySelector('.cursor-position'),
      autocompletePopup: this.container.querySelector('.autocomplete-popup'),
      autocompleteList: this.container.querySelector('.autocomplete-list')
    };
    
    this.addStyles();
  }
  
  // Ê∑ªÂä†Ê†∑Âºè
  addStyles() {
    if (document.getElementById('code-editor-styles')) return;
    
    const styles = document.createElement('style');
    styles.id = 'code-editor-styles';
    styles.textContent = `
      .code-editor {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
        display: flex;
        flex-direction: column;
        height: 500px;
      }
      
      .code-editor.dark {
        background: #1e1e1e;
        border-color: #444;
        color: #d4d4d4;
      }
      
      .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
      }
      
      .code-editor.dark .editor-header {
        background: #2d2d30;
        border-bottom-color: #444;
      }
      
      .editor-tabs {
        display: flex;
        gap: 4px;
      }
      
      .editor-tab {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 12px;
        background: #e9ecef;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
      }
      
      .editor-tab.active {
        background: #007bff;
        color: white;
      }
      
      .code-editor.dark .editor-tab {
        background: #444;
        color: #d4d4d4;
      }
      
      .tab-close {
        cursor: pointer;
        opacity: 0.7;
      }
      
      .tab-close:hover {
        opacity: 1;
      }
      
      .editor-actions {
        display: flex;
        gap: 4px;
      }
      
      .editor-btn {
        background: none;
        border: none;
        padding: 6px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }
      
      .editor-btn:hover {
        background: rgba(0, 0, 0, 0.1);
      }
      
      .code-editor.dark .editor-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      
      .editor-body {
        flex: 1;
        display: flex;
        position: relative;
        overflow: hidden;
      }
      
      .line-numbers {
        background: #f8f9fa;
        border-right: 1px solid #ddd;
        padding: 16px 8px;
        font-size: 14px;
        line-height: 1.5;
        color: #666;
        user-select: none;
        min-width: 50px;
        text-align: right;
      }
      
      .code-editor.dark .line-numbers {
        background: #2d2d30;
        border-right-color: #444;
        color: #999;
      }
      
      .editor-content {
        flex: 1;
        position: relative;
        overflow: auto;
      }
      
      .editor-lines {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 16px;
        font-size: 14px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
        pointer-events: none;
        z-index: 1;
      }
      
      .editor-textarea {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        padding: 16px;
        border: none;
        outline: none;
        background: transparent;
        color: transparent;
        caret-color: #007bff;
        font-size: 14px;
        line-height: 1.5;
        font-family: inherit;
        resize: none;
        z-index: 2;
      }
      
      .editor-cursor {
        position: absolute;
        width: 2px;
        height: 21px;
        background: #007bff;
        animation: blink 1s infinite;
        z-index: 3;
        pointer-events: none;
      }
      
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }
      
      .editor-selection {
        position: absolute;
        background: rgba(0, 123, 255, 0.2);
        z-index: 0;
        pointer-events: none;
      }
      
      .editor-footer {
        padding: 4px 12px;
        background: #f8f9fa;
        border-top: 1px solid #ddd;
        font-size: 12px;
      }
      
      .code-editor.dark .editor-footer {
        background: #2d2d30;
        border-top-color: #444;
      }
      
      .editor-status {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .autocomplete-popup {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
      }
      
      .code-editor.dark .autocomplete-popup {
        background: #2d2d30;
        border-color: #444;
        color: #d4d4d4;
      }
      
      .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .autocomplete-item:hover,
      .autocomplete-item.selected {
        background: #f0f0f0;
      }
      
      .code-editor.dark .autocomplete-item:hover,
      .code-editor.dark .autocomplete-item.selected {
        background: #444;
      }
      
      .autocomplete-icon {
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }
      
      /* ËØ≠Ê≥ïÈ´ò‰∫ÆÊ†∑Âºè */
      .syntax-keyword { color: #0066cc; font-weight: bold; }
      .syntax-string { color: #008000; }
      .syntax-number { color: #cc6600; }
      .syntax-comment { color: #999; font-style: italic; }
      .syntax-function { color: #6600cc; }
      .syntax-variable { color: #0066cc; }
      .syntax-operator { color: #666; }
      
      .code-editor.dark .syntax-keyword { color: #569cd6; }
      .code-editor.dark .syntax-string { color: #ce9178; }
      .code-editor.dark .syntax-number { color: #b5cea8; }
      .code-editor.dark .syntax-comment { color: #6a9955; }
      .code-editor.dark .syntax-function { color: #dcdcaa; }
      .code-editor.dark .syntax-variable { color: #9cdcfe; }
      .code-editor.dark .syntax-operator { color: #d4d4d4; }
    `;
    
    document.head.appendChild(styles);
  }
  
  // ÁªëÂÆö‰∫ã‰ª∂
  bindEvents() {
    const { textarea } = this.elements;
    
    // ÊñáÊú¨ËæìÂÖ•‰∫ã‰ª∂
    textarea.addEventListener('input', (e) => {
      this.handleInput(e);
    });
    
    // ÈîÆÁõò‰∫ã‰ª∂
    textarea.addEventListener('keydown', (e) => {
      this.handleKeyDown(e);
    });
    
    // ÂÖâÊ†áÂíåÈÄâÊã©‰∫ã‰ª∂
    textarea.addEventListener('selectionchange', () => {
      this.updateCursor();
    });
    
    textarea.addEventListener('scroll', () => {
      this.syncScroll();
    });
    
    // ÊåâÈíÆ‰∫ã‰ª∂
    document.getElementById('format-btn').addEventListener('click', () => {
      this.formatCode();
    });
    
    document.getElementById('save-btn').addEventListener('click', () => {
      this.save();
    });
    
    // ÂÖ®Â±ÄÈîÆÁõòÂø´Êç∑ÈîÆ
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 's':
            e.preventDefault();
            this.save();
            break;
          case 'z':
            e.preventDefault();
            if (e.shiftKey) {
              this.redo();
            } else {
              this.undo();
            }
            break;
          case 'f':
            e.preventDefault();
            this.showFindDialog();
            break;
        }
      }
    });
  }
  
  // Â§ÑÁêÜËæìÂÖ•
  handleInput(e) {
    const content = e.target.value;
    this.state.content = content;
    
    // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
    this.addToHistory();
    
    // Êõ¥Êñ∞ÊòæÁ§∫
    this.updateDisplay();
    this.updateLineNumbers();
    
    // Ëß¶ÂèëÂõûË∞É
    this.callbacks.onChange(content);
    
    // Ëá™Âä®Ë°•ÂÖ®
    if (this.options.autoComplete) {
      this.handleAutoComplete();
    }
  }
  
  // Â§ÑÁêÜÈîÆÁõòÊåâÈîÆ
  handleKeyDown(e) {
    const { textarea } = this.elements;
    
    switch (e.key) {
      case 'Tab':
        e.preventDefault();
        this.insertTab();
        break;
        
      case 'Enter':
        if (this.options.autoIndent) {
          this.handleAutoIndent(e);
        }
        break;
        
      case 'Backspace':
        this.handleBackspace(e);
        break;
        
      case 'ArrowUp':
      case 'ArrowDown':
      case 'ArrowLeft':
      case 'ArrowRight':
        setTimeout(() => this.updateCursor(), 0);
        break;
    }
  }
  
  // ÊèíÂÖ•Âà∂Ë°®Á¨¶
  insertTab() {
    const { textarea } = this.elements;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const spaces = ' '.repeat(this.options.tabSize);
    
    const before = textarea.value.substring(0, start);
    const after = textarea.value.substring(end);
    
    textarea.value = before + spaces + after;
    textarea.selectionStart = textarea.selectionEnd = start + spaces.length;
    
    this.handleInput({ target: textarea });
  }
  
  // Â§ÑÁêÜËá™Âä®Áº©Ëøõ
  handleAutoIndent(e) {
    const { textarea } = this.elements;
    const lines = textarea.value.split('\n');
    const currentLineIndex = textarea.value.substring(0, textarea.selectionStart).split('\n').length - 1;
    const currentLine = lines[currentLineIndex];
    
    // ËÆ°ÁÆóÂΩìÂâçË°åÁöÑÁº©Ëøõ
    const indent = currentLine.match(/^(\s*)/)[1];
    
    // Â¶ÇÊûúÂΩìÂâçË°å‰ª• { ÁªìÂ∞æÔºåÂ¢ûÂä†Áº©Ëøõ
    const extraIndent = currentLine.trim().endsWith('{') ? ' '.repeat(this.options.tabSize) : '';
    
    setTimeout(() => {
      const start = textarea.selectionStart;
      const before = textarea.value.substring(0, start);
      const after = textarea.value.substring(start);
      
      textarea.value = before + indent + extraIndent + after;
      textarea.selectionStart = textarea.selectionEnd = start + indent.length + extraIndent.length;
      
      this.handleInput({ target: textarea });
    }, 0);
  }
  
  // Êõ¥Êñ∞ÊòæÁ§∫
  updateDisplay() {
    const { lines } = this.elements;
    const content = this.state.content || '';
    
    // ËØ≠Ê≥ïÈ´ò‰∫Æ
    const highlightedContent = this.highlighter.highlight(content, this.state.language);
    lines.innerHTML = highlightedContent;
  }
  
  // Êõ¥Êñ∞Ë°åÂè∑
  updateLineNumbers() {
    if (!this.options.lineNumbers || !this.elements.lineNumbers) return;
    
    const lines = (this.state.content || '').split('\n');
    const lineNumbers = lines.map((_, index) => index + 1).join('\n');
    this.elements.lineNumbers.textContent = lineNumbers;
  }
  
  // Êõ¥Êñ∞ÂÖâÊ†á‰ΩçÁΩÆ
  updateCursor() {
    const { textarea, cursor, statusPosition } = this.elements;
    
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const content = textarea.value.substring(0, start);
    const lines = content.split('\n');
    
    const line = lines.length;
    const column = lines[lines.length - 1].length + 1;
    
    this.state.cursor = { line, column };
    
    // Êõ¥Êñ∞Áä∂ÊÄÅÊ†è
    if (statusPosition) {
      statusPosition.textContent = `Á¨¨ ${line} Ë°åÔºåÁ¨¨ ${column} Âàó`;
    }
    
    // Êõ¥Êñ∞ÂÖâÊ†á‰ΩçÁΩÆ
    this.updateCursorPosition();
    
    this.callbacks.onCursorChange(this.state.cursor);
  }
  
  // Êõ¥Êñ∞ÂÖâÊ†á‰ΩçÁΩÆ
  updateCursorPosition() {
    const { textarea, cursor } = this.elements;
    
    // ÂàõÂª∫‰∏¥Êó∂ÂÖÉÁ¥†Êù•ÊµãÈáè‰ΩçÁΩÆ
    const measure = document.createElement('div');
    measure.style.cssText = `
      position: absolute;
      visibility: hidden;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: inherit;
      font-size: inherit;
      line-height: inherit;
      padding: 16px;
    `;
    
    const content = textarea.value.substring(0, textarea.selectionStart);
    measure.textContent = content;
    
    this.container.appendChild(measure);
    
    const rect = measure.getBoundingClientRect();
    const containerRect = this.elements.lines.getBoundingClientRect();
    
    cursor.style.left = (rect.width % (containerRect.width - 32)) + 16 + 'px';
    cursor.style.top = Math.floor(rect.width / (containerRect.width - 32)) * 21 + 16 + 'px';
    
    this.container.removeChild(measure);
  }
  
  // ÂêåÊ≠•ÊªöÂä®
  syncScroll() {
    const { textarea, lines, lineNumbers } = this.elements;
    
    if (lines) {
      lines.scrollTop = textarea.scrollTop;
      lines.scrollLeft = textarea.scrollLeft;
    }
    
    if (lineNumbers) {
      lineNumbers.scrollTop = textarea.scrollTop;
    }
  }
  
  // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
  addToHistory() {
    const state = {
      content: this.state.content,
      cursor: { ...this.state.cursor }
    };
    
    // ÁßªÈô§ÂΩìÂâç‰ΩçÁΩÆÂêéÁöÑÂéÜÂè≤
    this.state.history = this.state.history.slice(0, this.state.historyIndex + 1);
    
    // Ê∑ªÂä†Êñ∞Áä∂ÊÄÅ
    this.state.history.push(state);
    this.state.historyIndex = this.state.history.length - 1;
    
    // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè
    if (this.state.history.length > 100) {
      this.state.history.shift();
      this.state.historyIndex--;
    }
  }
  
  // Êí§ÈîÄ
  undo() {
    if (this.state.historyIndex > 0) {
      this.state.historyIndex--;
      const state = this.state.history[this.state.historyIndex];
      this.restoreState(state);
    }
  }
  
  // ÈáçÂÅö
  redo() {
    if (this.state.historyIndex < this.state.history.length - 1) {
      this.state.historyIndex++;
      const state = this.state.history[this.state.historyIndex];
      this.restoreState(state);
    }
  }
  
  // ÊÅ¢Â§çÁä∂ÊÄÅ
  restoreState(state) {
    this.state.content = state.content;
    this.state.cursor = state.cursor;
    this.elements.textarea.value = state.content;
    this.updateDisplay();
    this.updateLineNumbers();
    this.updateCursor();
  }
  
  // Ê†ºÂºèÂåñ‰ª£Á†Å
  formatCode() {
    try {
      let formatted = this.state.content;
      
      if (this.state.language === 'javascript') {
        formatted = this.formatJavaScript(formatted);
      } else if (this.state.language === 'json') {
        formatted = JSON.stringify(JSON.parse(formatted), null, this.options.tabSize);
      }
      
      this.setValue(formatted);
    } catch (error) {
      console.error('Format error:', error);
    }
  }
  
  // ÁÆÄÂçïÁöÑJavaScriptÊ†ºÂºèÂåñ
  formatJavaScript(code) {
    // ËøôÊòØ‰∏Ä‰∏™ÁÆÄÂåñÁöÑÊ†ºÂºèÂåñÂÆûÁé∞
    let indentLevel = 0;
    const indent = ' '.repeat(this.options.tabSize);
    
    return code
      .split('\n')
      .map(line => {
        const trimmed = line.trim();
        if (!trimmed) return '';
        
        if (trimmed.includes('}')) indentLevel--;
        const formatted = indent.repeat(Math.max(0, indentLevel)) + trimmed;
        if (trimmed.includes('{')) indentLevel++;
        
        return formatted;
      })
      .join('\n');
  }
  
  // Â§ÑÁêÜËá™Âä®Ë°•ÂÖ®
  handleAutoComplete() {
    const { textarea } = this.elements;
    const cursor = textarea.selectionStart;
    const line = textarea.value.substring(0, cursor).split('\n').pop();
    const word = line.match(/\w+$/);
    
    if (word && word[0].length >= 2) {
      const suggestions = this.autoComplete.getSuggestions(word[0], this.state.language);
      this.showAutoComplete(suggestions);
    } else {
      this.hideAutoComplete();
    }
  }
  
  // ÊòæÁ§∫Ëá™Âä®Ë°•ÂÖ®
  showAutoComplete(suggestions) {
    const { autocompletePopup, autocompleteList } = this.elements;
    
    if (suggestions.length === 0) {
      this.hideAutoComplete();
      return;
    }
    
    autocompleteList.innerHTML = suggestions.map((suggestion, index) => `
      <div class="autocomplete-item ${index === 0 ? 'selected' : ''}" data-index="${index}">
        <div class="autocomplete-icon">${suggestion.icon}</div>
        <div class="autocomplete-text">${suggestion.text}</div>
      </div>
    `).join('');
    
    autocompletePopup.style.display = 'block';
    // ËøôÈáåÂ∫îËØ•ËÆ°ÁÆó‰ΩçÁΩÆÔºåÁÆÄÂåñÂ§ÑÁêÜ
    autocompletePopup.style.top = '100px';
    autocompletePopup.style.left = '100px';
  }
  
  // ÈöêËóèËá™Âä®Ë°•ÂÖ®
  hideAutoComplete() {
    this.elements.autocompletePopup.style.display = 'none';
  }
  
  // ËÆæÁΩÆËØ≠Ë®Ä
  setLanguage(language) {
    this.state.language = language;
    this.updateDisplay();
  }
  
  // ËÆæÁΩÆ‰∏ªÈ¢ò
  setTheme(theme) {
    this.container.querySelector('.code-editor').className = `code-editor ${theme}`;
  }
  
  // ËÆæÁΩÆÂÄº
  setValue(content) {
    this.state.content = content;
    this.elements.textarea.value = content;
    this.updateDisplay();
    this.updateLineNumbers();
    this.addToHistory();
  }
  
  // Ëé∑ÂèñÂÄº
  getValue() {
    return this.state.content;
  }
  
  // ‰øùÂ≠ò
  save() {
    this.callbacks.onSave(this.state.content);
  }
  
  // ËÆæÁΩÆÂ≠ó‰ΩìÂ§ßÂ∞è
  setFontSize(size) {
    this.options.fontSize = size;
    this.container.style.fontSize = size + 'px';
  }
  
  // ÈîÄÊØÅÁºñËæëÂô®
  destroy() {
    this.container.innerHTML = '';
  }
}

// 2. ËØ≠Ê≥ïÈ´ò‰∫ÆÂô®
class SyntaxHighlighter {
  constructor() {
    this.rules = {
      javascript: [
        { pattern: /\b(function|var|let|const|if|else|for|while|do|switch|case|break|continue|return|try|catch|finally|throw|new|this|class|extends|import|export|from|default)\b/g, className: 'syntax-keyword' },
        { pattern: /(["'])((?:\\.|(?!\1)[^\\])*?)\1/g, className: 'syntax-string' },
        { pattern: /\b\d+(\.\d+)?\b/g, className: 'syntax-number' },
        { pattern: /\/\/.*$/gm, className: 'syntax-comment' },
        { pattern: /\/\*[\s\S]*?\*\//g, className: 'syntax-comment' },
        { pattern: /\b[a-zA-Z_$][a-zA-Z0-9_$]*\s*(?=\()/g, className: 'syntax-function' }
      ],
      html: [
        { pattern: /(<\/?)([\w-]+)(.*?>)/g, className: 'syntax-keyword' },
        { pattern: /(["'])((?:\\.|(?!\1)[^\\])*?)\1/g, className: 'syntax-string' },
        { pattern: /<!--[\s\S]*?-->/g, className: 'syntax-comment' }
      ],
      css: [
        { pattern: /\b(color|background|font|margin|padding|border|width|height|display|position|top|left|right|bottom)\b/g, className: 'syntax-keyword' },
        { pattern: /(["'])((?:\\.|(?!\1)[^\\])*?)\1/g, className: 'syntax-string' },
        { pattern: /#[0-9a-fA-F]{3,6}\b/g, className: 'syntax-number' },
        { pattern: /\/\*[\s\S]*?\*\//g, className: 'syntax-comment' }
      ]
    };
  }
  
  highlight(code, language) {
    const rules = this.rules[language] || [];
    let highlighted = this.escapeHtml(code);
    
    rules.forEach(rule => {
      highlighted = highlighted.replace(rule.pattern, (match, ...groups) => {
        return `<span class="${rule.className}">${match}</span>`;
      });
    });
    
    return highlighted;
  }
  
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

// 3. Ëá™Âä®Ë°•ÂÖ®
class AutoComplete {
  constructor() {
    this.suggestions = {
      javascript: [
        { text: 'function', icon: 'üîß' },
        { text: 'console.log', icon: 'üìù' },
        { text: 'document.getElementById', icon: 'üåê' },
        { text: 'addEventListener', icon: 'üëÇ' },
        { text: 'querySelector', icon: 'üîç' },
        { text: 'createElement', icon: '‚ú®' },
        { text: 'appendChild', icon: '‚ûï' },
        { text: 'removeChild', icon: '‚ûñ' },
        { text: 'setTimeout', icon: '‚è∞' },
        { text: 'setInterval', icon: 'üîÑ' }
      ]
    };
  }
  
  getSuggestions(prefix, language) {
    const suggestions = this.suggestions[language] || [];
    return suggestions.filter(suggestion => 
      suggestion.text.toLowerCase().startsWith(prefix.toLowerCase())
    );
  }
}

// 4. ÊºîÁ§∫Â∫îÁî®
class CodeEditorDemo {
  constructor() {
    this.setupUI();
    this.initEditor();
    this.setupExamples();
  }
  
  setupUI() {
    document.body.innerHTML = `
      <div style="max-width: 1200px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
        <h1>‰ª£Á†ÅÁºñËæëÂô®ÊºîÁ§∫</h1>
        
        <div style="margin-bottom: 20px;">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <div>
              <label>ËØ≠Ë®Ä: </label>
              <select id="language-select">
                <option value="javascript">JavaScript</option>
                <option value="html">HTML</option>
                <option value="css">CSS</option>
                <option value="json">JSON</option>
              </select>
            </div>
            
            <div>
              <label>‰∏ªÈ¢ò: </label>
              <select id="theme-select">
                <option value="light">ÊµÖËâ≤</option>
                <option value="dark">Ê∑±Ëâ≤</option>
              </select>
            </div>
            
            <div>
              <label>Â≠ó‰ΩìÂ§ßÂ∞è: </label>
              <input type="range" id="font-size" min="12" max="20" value="14">
              <span id="font-size-value">14px</span>
            </div>
            
            <div>
              <label>Áº©ËøõÂ§ßÂ∞è: </label>
              <input type="range" id="tab-size" min="2" max="8" value="2">
              <span id="tab-size-value">2</span>
            </div>
          </div>
          
          <div style="margin-top: 16px;">
            <label><input type="checkbox" id="line-numbers" checked> ÊòæÁ§∫Ë°åÂè∑</label>
            <label><input type="checkbox" id="word-wrap" checked> Ëá™Âä®Êç¢Ë°å</label>
            <label><input type="checkbox" id="auto-indent" checked> Ëá™Âä®Áº©Ëøõ</label>
            <label><input type="checkbox" id="auto-complete" checked> Ëá™Âä®Ë°•ÂÖ®</label>
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <h3>Á§∫‰æã‰ª£Á†Å</h3>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="example-btn" data-example="hello-world">Hello World</button>
            <button class="example-btn" data-example="todo-app">Todo Â∫îÁî®</button>
            <button class="example-btn" data-example="api-fetch">API ËØ∑Ê±Ç</button>
            <button class="example-btn" data-example="class-demo">Á±ªÂÆö‰πâ</button>
            <button class="example-btn" data-example="async-demo">ÂºÇÊ≠•ÂáΩÊï∞</button>
          </div>
        </div>
        
        <div id="editor-container"></div>
        
        <div style="margin-top: 20px;">
          <h3>ÁºñËæëÂô®Áä∂ÊÄÅ</h3>
          <div id="editor-stats" style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
          "></div>
        </div>
        
        <div style="margin-top: 20px;">
          <h3>Âø´Êç∑ÈîÆËØ¥Êòé</h3>
          <div style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
          ">
            <div><kbd>Ctrl+S</kbd> - ‰øùÂ≠òÊñá‰ª∂</div>
            <div><kbd>Ctrl+Z</kbd> - Êí§ÈîÄÊìç‰Ωú</div>
            <div><kbd>Ctrl+Shift+Z</kbd> - ÈáçÂÅöÊìç‰Ωú</div>
            <div><kbd>Tab</kbd> - ÊèíÂÖ•Áº©Ëøõ</div>
            <div><kbd>Enter</kbd> - Ëá™Âä®Áº©Ëøõ</div>
            <div><kbd>Ctrl+F</kbd> - Êü•ÊâæÊñáÊú¨</div>
          </div>
        </div>
      </div>
      
      <style>
        .example-btn {
          padding: 6px 12px;
          border: 1px solid #ddd;
          border-radius: 4px;
          background: white;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.2s;
        }
        
        .example-btn:hover {
          background: #f0f0f0;
          border-color: #007bff;
        }
        
        select, input[type="range"] {
          margin-left: 8px;
          margin-right: 16px;
        }
        
        label {
          margin-right: 16px;
          display: inline-flex;
          align-items: center;
          gap: 4px;
        }
        
        kbd {
          background: #f8f9fa;
          border: 1px solid #ddd;
          border-radius: 3px;
          padding: 2px 6px;
          font-family: monospace;
          font-size: 12px;
        }
      </style>
    `;
  }
  
  initEditor() {
    this.editor = new CodeEditor('#editor-container', {
      language: 'javascript',
      theme: 'light',
      onChange: (content) => {
        this.updateStats();
      },
      onSave: (content) => {
        console.log('‰øùÂ≠òÊñá‰ª∂:', content);
        alert('Êñá‰ª∂Â∑≤‰øùÂ≠òÔºÅ');
      }
    });
    
    this.bindEvents();
    this.updateStats();
  }
  
  setupExamples() {
    this.examples = {
      'hello-world': `// Hello World Á§∫‰æã
console.log('Hello, World!');

// ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑÈóÆÂÄôÂáΩÊï∞
function greet(name) {
  return \`Hello, \${name}!\`;
}

// ‰ΩøÁî®ÂáΩÊï∞
const message = greet('ÂâçÁ´ØÂºÄÂèëËÄÖ');
console.log(message);`,

      'todo-app': `// ÁÆÄÂçïÁöÑ Todo Â∫îÁî®
class TodoApp {
  constructor() {
    this.todos = [];
    this.nextId = 1;
  }
  
  addTodo(text) {
    const todo = {
      id: this.nextId++,
      text: text,
      completed: false,
      createdAt: new Date()
    };
    this.todos.push(todo);
    return todo;
  }
  
  toggleTodo(id) {
    const todo = this.todos.find(t => t.id === id);
    if (todo) {
      todo.completed = !todo.completed;
    }
  }
  
  deleteTodo(id) {
    this.todos = this.todos.filter(t => t.id !== id);
  }
  
  getActiveTodos() {
    return this.todos.filter(t => !t.completed);
  }
  
  getCompletedTodos() {
    return this.todos.filter(t => t.completed);
  }
}

// ‰ΩøÁî®Á§∫‰æã
const app = new TodoApp();
app.addTodo('Â≠¶‰π† JavaScript');
app.addTodo('ÊûÑÂª∫È°πÁõÆ');
app.addTodo('ÈÉ®ÁΩ≤Â∫îÁî®');

console.log('ÊâÄÊúâÂæÖÂäû:', app.todos);
console.log('Êú™ÂÆåÊàê:', app.getActiveTodos());`,

      'api-fetch': `// API ËØ∑Ê±ÇÁ§∫‰æã
class ApiService {
  constructor(baseURL) {
    this.baseURL = baseURL;
  }
  
  async request(endpoint, options = {}) {
    const url = \`\${this.baseURL}\${endpoint}\`;
    const config = {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers
      },
      ...options
    };
    
    try {
      const response = await fetch(url, config);
      
      if (!response.ok) {
        throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
      throw error;
    }
  }
  
  async get(endpoint) {
    return this.request(endpoint, { method: 'GET' });
  }
  
  async post(endpoint, data) {
    return this.request(endpoint, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }
  
  async put(endpoint, data) {
    return this.request(endpoint, {
      method: 'PUT',
      body: JSON.stringify(data)
    });
  }
  
  async delete(endpoint) {
    return this.request(endpoint, { method: 'DELETE' });
  }
}

// ‰ΩøÁî®Á§∫‰æã
const api = new ApiService('https://api.example.com');

async function loadUsers() {
  try {
    const users = await api.get('/users');
    console.log('Áî®Êà∑ÂàóË°®:', users);
  } catch (error) {
    console.error('Âä†ËΩΩÁî®Êà∑Â§±Ë¥•:', error);
  }
}

loadUsers();`,

      'class-demo': `// ES6 Á±ªÂÆö‰πâÁ§∫‰æã
class Vehicle {
  constructor(brand, model, year) {
    this.brand = brand;
    this.model = model;
    this.year = year;
    this.isRunning = false;
  }
  
  start() {
    if (!this.isRunning) {
      this.isRunning = true;
      console.log(\`\${this.brand} \${this.model} Â∑≤ÂêØÂä®\`);
    }
  }
  
  stop() {
    if (this.isRunning) {
      this.isRunning = false;
      console.log(\`\${this.brand} \${this.model} Â∑≤ÂÅúÊ≠¢\`);
    }
  }
  
  getInfo() {
    return \`\${this.year} \${this.brand} \${this.model}\`;
  }
  
  // ÈùôÊÄÅÊñπÊ≥ï
  static compare(vehicle1, vehicle2) {
    return vehicle1.year - vehicle2.year;
  }
}

// ÁªßÊâøÁ§∫‰æã
class Car extends Vehicle {
  constructor(brand, model, year, doors) {
    super(brand, model, year);
    this.doors = doors;
  }
  
  honk() {
    console.log('ÂòÄÂòÄÔºÅ');
  }
  
  getInfo() {
    return \`\${super.getInfo()} (\${this.doors}Èó®)\`;
  }
}

// ‰ΩøÁî®Á§∫‰æã
const car1 = new Car('‰∏∞Áî∞', 'Âç°ÁΩóÊãâ', 2023, 4);
const car2 = new Car('Êú¨Áî∞', 'ÈõÖÈòÅ', 2022, 4);

car1.start();
car1.honk();
console.log(car1.getInfo());

console.log('Âπ¥‰ªΩÂ∑ÆÂºÇ:', Vehicle.compare(car1, car2));`,

      'async-demo': `// ÂºÇÊ≠•ÁºñÁ®ãÁ§∫‰æã
// Promise Âü∫Á°Ä
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// async/await ÂáΩÊï∞
async function asyncExample() {
  console.log('ÂºÄÂßãÂºÇÊ≠•Êìç‰Ωú...');
  
  try {
    // Âπ∂Ë°åÊâßË°åÂ§ö‰∏™ÂºÇÊ≠•Êìç‰Ωú
    const [result1, result2, result3] = await Promise.all([
      fetchUserData(1),
      fetchUserData(2),
      fetchUserData(3)
    ]);
    
    console.log('ÊâÄÊúâÁî®Êà∑Êï∞ÊçÆ:', { result1, result2, result3 });
    
    // ‰∏≤Ë°åÊâßË°å
    for (let i = 1; i <= 3; i++) {
      const user = await fetchUserData(i);
      console.log(\`Áî®Êà∑ \${i}:\`, user);
      await delay(500); // Âª∂Ëøü500ms
    }
    
  } catch (error) {
    console.error('ÂºÇÊ≠•Êìç‰ΩúÂ§±Ë¥•:', error);
  }
}

// Ê®°ÊãüÂºÇÊ≠•Êï∞ÊçÆËé∑Âèñ
async function fetchUserData(userId) {
  await delay(Math.random() * 1000 + 500); // Ê®°ÊãüÁΩëÁªúÂª∂Ëøü
  
  // Ê®°ÊãüÂÅ∂Â∞îÂ§±Ë¥•
  if (Math.random() < 0.1) {
    throw new Error(\`Ëé∑ÂèñÁî®Êà∑ \${userId} Êï∞ÊçÆÂ§±Ë¥•\`);
  }
  
  return {
    id: userId,
    name: \`Áî®Êà∑\${userId}\`,
    email: \`user\${userId}@example.com\`,
    lastLogin: new Date()
  };
}

// Generator ÂáΩÊï∞Á§∫‰æã
function* numberGenerator() {
  let i = 1;
  while (true) {
    yield i++;
  }
}

// ‰ΩøÁî®ÁîüÊàêÂô®
const numbers = numberGenerator();
console.log(numbers.next().value); // 1
console.log(numbers.next().value); // 2
console.log(numbers.next().value); // 3

// ÊâßË°åÂºÇÊ≠•Á§∫‰æã
asyncExample();`
    };
  }
  
  bindEvents() {
    // ËØ≠Ë®ÄÂàáÊç¢
    document.getElementById('language-select').addEventListener('change', (e) => {
      this.editor.setLanguage(e.target.value);
    });
    
    // ‰∏ªÈ¢òÂàáÊç¢
    document.getElementById('theme-select').addEventListener('change', (e) => {
      this.editor.setTheme(e.target.value);
    });
    
    // Â≠ó‰ΩìÂ§ßÂ∞è
    const fontSizeInput = document.getElementById('font-size');
    const fontSizeValue = document.getElementById('font-size-value');
    fontSizeInput.addEventListener('input', (e) => {
      const size = e.target.value;
      fontSizeValue.textContent = size + 'px';
      this.editor.setFontSize(parseInt(size));
    });
    
    // Á§∫‰æãÊåâÈíÆ
    document.querySelectorAll('.example-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const example = e.target.dataset.example;
        if (this.examples[example]) {
          this.editor.setValue(this.examples[example]);
        }
      });
    });
  }
  
  updateStats() {
    const content = this.editor.getValue();
    const lines = content.split('\n').length;
    const characters = content.length;
    const words = content.trim() ? content.trim().split(/\s+/).length : 0;
    const cursor = this.editor.state.cursor;
    
    document.getElementById('editor-stats').innerHTML = `
      <div><strong>Ë°åÊï∞:</strong> ${lines}</div>
      <div><strong>Â≠óÁ¨¶Êï∞:</strong> ${characters}</div>
      <div><strong>ÂçïËØçÊï∞:</strong> ${words}</div>
      <div><strong>ÂÖâÊ†á‰ΩçÁΩÆ:</strong> ${cursor.line}:${cursor.column}</div>
      <div><strong>ËØ≠Ë®Ä:</strong> ${this.editor.state.language}</div>
      <div><strong>ÂéÜÂè≤ËÆ∞ÂΩï:</strong> ${this.editor.state.history.length}</div>
    `;
  }
}

// ËøêË°åÊºîÁ§∫
console.log('=== ‰ª£Á†ÅÁºñËæëÂô®ÊµãËØï ===\n');

const demo = new CodeEditorDemo();

console.log('‰ª£Á†ÅÁºñËæëÂô®ÂäüËÉΩÁâπÁÇπÔºö');
console.log('‚úì ËØ≠Ê≥ïÈ´ò‰∫ÆÂíå‰∏ªÈ¢òÂàáÊç¢');
console.log('‚úì Êô∫ËÉΩÁº©ËøõÂíåËá™Âä®Ë°•ÂÖ®');
console.log('‚úì Êí§ÈîÄÈáçÂÅöÂíåÂéÜÂè≤ËÆ∞ÂΩï');
console.log('‚úì ‰ª£Á†ÅÊ†ºÂºèÂåñ');
console.log('‚úì Âø´Êç∑ÈîÆÊîØÊåÅ');
console.log('‚úì Ë°åÂè∑ÂíåÂÖâÊ†áÂÆö‰Ωç');
console.log('‚úì Â§öËØ≠Ë®ÄÊîØÊåÅ');
console.log('‚úì ÊÄßËÉΩ‰ºòÂåñ');

// ÂØºÂá∫
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    CodeEditor,
    SyntaxHighlighter,
    AutoComplete
  };
}
