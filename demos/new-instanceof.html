<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New/Instanceof å®ç°æ¼”ç¤º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .demo-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #6f42c1;
        }
        
        .demo-section h2 {
            color: #6f42c1;
            margin-bottom: 15px;
        }
        
        .test-button {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .test-button:hover {
            background: #5a32a3;
        }
        
        .test-button.success {
            background: #28a745;
        }
        
        .test-button.success:hover {
            background: #1e7e34;
        }
        
        .test-button.info {
            background: #17a2b8;
        }
        
        .test-button.info:hover {
            background: #138496;
        }
        
        .test-button.warning {
            background: #ffc107;
            color: #212529;
        }
        
        .test-button.warning:hover {
            background: #e0a800;
        }
        
        .result {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .constructor-demo {
            background: white;
            border: 2px solid #6f42c1;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .constructor-demo h4 {
            margin: 0 0 10px 0;
            color: #6f42c1;
        }
        
        .prototype-chain {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        
        .chain-item {
            padding: 5px 0;
            border-bottom: 1px dashed #ccc;
        }
        
        .chain-item:last-child {
            border-bottom: none;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .comparison-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .comparison-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .back-link {
            display: inline-block;
            color: #007bff;
            text-decoration: none;
            margin-bottom: 20px;
            padding: 8px 15px;
            border: 1px solid #007bff;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background: #007bff;
            color: white;
        }
        
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            color: #856404;
        }
        
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
    
    <div class="demo-container">
        <h1>ğŸ—ï¸ New/Instanceof å®ç°æ¼”ç¤º</h1>
        
        <div class="demo-section">
            <h2>ğŸ”§ New æ“ä½œç¬¦æµ‹è¯•</h2>
            <p>æµ‹è¯•è‡ªå®ç°çš„ new æ“ä½œç¬¦åŠŸèƒ½</p>
            
            <button class="test-button" onclick="testBasicNew()">åŸºç¡€æ„é€ å‡½æ•°</button>
            <button class="test-button success" onclick="testComplexConstructor()">å¤æ‚æ„é€ å‡½æ•°</button>
            <button class="test-button info" onclick="testReturnValue()">è¿”å›å€¼å¤„ç†</button>
            <button class="test-button warning" onclick="testArrowFunction()">ç®­å¤´å‡½æ•°æµ‹è¯•</button>
            
            <div class="result" id="new-result"></div>
            
            <div class="constructor-demo" id="constructor-comparison" style="display: none;">
                <h4>æ„é€ å‡½æ•°å¯¹æ¯”</h4>
                <div class="comparison-grid">
                    <div class="comparison-item">
                        <h4>åŸç”Ÿ new</h4>
                        <div id="native-new-result"></div>
                    </div>
                    <div class="comparison-item">
                        <h4>myNew å®ç°</h4>
                        <div id="my-new-result"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="demo-section">
            <h2>ğŸ” Instanceof æ“ä½œç¬¦æµ‹è¯•</h2>
            <p>æµ‹è¯•è‡ªå®ç°çš„ instanceof æ“ä½œç¬¦åŠŸèƒ½</p>
            
            <button class="test-button" onclick="testBasicInstanceof()">åŸºç¡€ç±»å‹æ£€æµ‹</button>
            <button class="test-button success" onclick="testInheritanceChain()">ç»§æ‰¿é“¾æ£€æµ‹</button>
            <button class="test-button info" onclick="testPrimitiveTypes()">åŸºæœ¬ç±»å‹å¤„ç†</button>
            <button class="test-button warning" onclick="testSymbolHasInstance()">Symbol.hasInstance</button>
            
            <div class="result" id="instanceof-result"></div>
            
            <div class="prototype-chain" id="prototype-visualization" style="display: none;">
                <strong>åŸå‹é“¾å¯è§†åŒ–ï¼š</strong>
                <div id="chain-items"></div>
            </div>
        </div>
        
        <div class="demo-section">
            <h2>ğŸ¯ ç»¼åˆåº”ç”¨æµ‹è¯•</h2>
            <p>ç»“åˆ new å’Œ instanceof çš„å¤æ‚åœºæ™¯æµ‹è¯•</p>
            
            <button class="test-button" onclick="testComplexScenario()">å¤æ‚åœºæ™¯</button>
            <button class="test-button success" onclick="testClassInheritance()">ç±»ç»§æ‰¿</button>
            <button class="test-button info" onclick="testMixinPattern()">æ··å…¥æ¨¡å¼</button>
            
            <div class="result" id="complex-result"></div>
        </div>
        
        <div class="demo-section">
            <h2>âš¡ æ€§èƒ½å’Œè¾¹ç•Œæµ‹è¯•</h2>
            <p>æµ‹è¯•æ€§èƒ½è¡¨ç°å’Œå„ç§è¾¹ç•Œæƒ…å†µ</p>
            
            <button class="test-button" onclick="runPerformanceTest()">æ€§èƒ½æµ‹è¯•</button>
            <button class="test-button success" onclick="testEdgeCases()">è¾¹ç•Œæƒ…å†µ</button>
            <button class="test-button info" onclick="testErrorHandling()">é”™è¯¯å¤„ç†</button>
            
            <div class="result" id="performance-result"></div>
        </div>
    </div>

    <script src="../vanilla-js/new.js"></script>
    <script src="../vanilla-js/instanceof.js"></script>
    
    <script>
        // æµ‹è¯•ç”¨çš„æ„é€ å‡½æ•°
        function Person(name, age) {
            this.name = name;
            this.age = age;
            this.greet = function() {
                return `Hello, I'm ${this.name}`;
            };
        }
        
        Person.prototype.sayAge = function() {
            return `I'm ${this.age} years old`;
        };
        
        function Student(name, age, school) {
            Person.call(this, name, age);
            this.school = school;
        }
        
        Student.prototype = Object.create(Person.prototype);
        Student.prototype.constructor = Student;
        Student.prototype.study = function() {
            return `${this.name} is studying at ${this.school}`;
        };
        
        // æµ‹è¯•åŸºç¡€ new æ“ä½œç¬¦
        function testBasicNew() {
            const result = document.getElementById('new-result');
            const comparison = document.getElementById('constructor-comparison');
            
            try {
                // ä½¿ç”¨åŸç”Ÿ new
                const person1 = new Person('Alice', 25);
                
                // ä½¿ç”¨ myNew
                const person2 = myNew(Person, 'Bob', 30);
                
                // æ¯”è¾ƒç»“æœ
                const tests = [
                    {
                        name: 'å®ä¾‹ç±»å‹',
                        native: person1 instanceof Person,
                        my: person2 instanceof Person
                    },
                    {
                        name: 'å±æ€§è®¾ç½®',
                        native: person1.name === 'Alice' && person1.age === 25,
                        my: person2.name === 'Bob' && person2.age === 30
                    },
                    {
                        name: 'æ–¹æ³•è°ƒç”¨',
                        native: person1.greet() === "Hello, I'm Alice",
                        my: person2.greet() === "Hello, I'm Bob"
                    },
                    {
                        name: 'åŸå‹æ–¹æ³•',
                        native: person1.sayAge() === "I'm 25 years old",
                        my: person2.sayAge() === "I'm 30 years old"
                    },
                    {
                        name: 'æ„é€ å‡½æ•°å±æ€§',
                        native: person1.constructor === Person,
                        my: person2.constructor === Person
                    }
                ];
                
                result.textContent = `ğŸ”§ åŸºç¡€ new æ“ä½œç¬¦æµ‹è¯•ç»“æœ:\n\n`;
                
                let allPassed = true;
                tests.forEach(test => {
                    const passed = test.native === test.my && test.native === true;
                    allPassed = allPassed && passed;
                    result.textContent += `${passed ? 'âœ…' : 'âŒ'} ${test.name}: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}\n`;
                    result.textContent += `   åŸç”Ÿ: ${test.native}, myNew: ${test.my}\n`;
                });
                
                result.textContent += `\nğŸ¯ æ€»ä½“ç»“æœ: ${allPassed ? 'âœ… å…¨éƒ¨é€šè¿‡' : 'âŒ å­˜åœ¨é—®é¢˜'}\n`;
                
                // æ˜¾ç¤ºå¯¹æ¯”
                document.getElementById('native-new-result').innerHTML = `
                    <strong>Personå®ä¾‹ (åŸç”Ÿ):</strong><br>
                    name: ${person1.name}<br>
                    age: ${person1.age}<br>
                    greet(): ${person1.greet()}<br>
                    sayAge(): ${person1.sayAge()}<br>
                    constructor: ${person1.constructor.name}
                `;
                
                document.getElementById('my-new-result').innerHTML = `
                    <strong>Personå®ä¾‹ (myNew):</strong><br>
                    name: ${person2.name}<br>
                    age: ${person2.age}<br>
                    greet(): ${person2.greet()}<br>
                    sayAge(): ${person2.sayAge()}<br>
                    constructor: ${person2.constructor.name}
                `;
                
                comparison.style.display = 'block';
                
            } catch (error) {
                result.textContent = `âŒ åŸºç¡€æµ‹è¯•å¤±è´¥: ${error.message}`;
                comparison.style.display = 'none';
            }
        }
        
        // æµ‹è¯•å¤æ‚æ„é€ å‡½æ•°
        function testComplexConstructor() {
            const result = document.getElementById('new-result');
            
            try {
                function ComplexConstructor(config) {
                    this.id = config.id || Math.random();
                    this.data = config.data || {};
                    this.created = new Date();
                    
                    // å¤æ‚åˆå§‹åŒ–
                    if (config.initialize) {
                        this.init();
                    }
                    
                    // ç§æœ‰æ–¹æ³•
                    this.getValue = function(key) {
                        return this.data[key];
                    };
                }
                
                ComplexConstructor.prototype.init = function() {
                    this.initialized = true;
                    this.status = 'ready';
                };
                
                const config = {
                    id: 'test-123',
                    data: { name: 'Test', value: 42 },
                    initialize: true
                };
                
                const obj1 = new ComplexConstructor(config);
                const obj2 = myNew(ComplexConstructor, config);
                
                result.textContent = `ğŸ—ï¸ å¤æ‚æ„é€ å‡½æ•°æµ‹è¯•:\n\n`;
                result.textContent += `åŸç”Ÿæ„é€ :\n`;
                result.textContent += `  ID: ${obj1.id}\n`;
                result.textContent += `  Data: ${JSON.stringify(obj1.data)}\n`;
                result.textContent += `  Initialized: ${obj1.initialized}\n`;
                result.textContent += `  Status: ${obj1.status}\n`;
                result.textContent += `  getValue('name'): ${obj1.getValue('name')}\n`;
                
                result.textContent += `\nmyNewæ„é€ :\n`;
                result.textContent += `  ID: ${obj2.id}\n`;
                result.textContent += `  Data: ${JSON.stringify(obj2.data)}\n`;
                result.textContent += `  Initialized: ${obj2.initialized}\n`;
                result.textContent += `  Status: ${obj2.status}\n`;
                result.textContent += `  getValue('name'): ${obj2.getValue('name')}\n`;
                
                const identical = JSON.stringify(obj1) === JSON.stringify(obj2);
                result.textContent += `\nğŸ¯ ç»“æœä¸€è‡´æ€§: ${identical ? 'âœ… ä¸€è‡´' : 'âš ï¸ å­˜åœ¨å·®å¼‚'}`;
                
            } catch (error) {
                result.textContent = `âŒ å¤æ‚æ„é€ å‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•è¿”å›å€¼å¤„ç†
        function testReturnValue() {
            const result = document.getElementById('new-result');
            
            try {
                // è¿”å›å¯¹è±¡çš„æ„é€ å‡½æ•°
                function ReturnObject() {
                    this.name = 'internal';
                    return { name: 'external', type: 'custom' };
                }
                
                // è¿”å›åŸºæœ¬ç±»å‹çš„æ„é€ å‡½æ•°
                function ReturnPrimitive() {
                    this.name = 'internal';
                    return 'string'; // åº”è¯¥è¢«å¿½ç•¥
                }
                
                // ä¸è¿”å›çš„æ„é€ å‡½æ•°
                function NoReturn() {
                    this.name = 'internal';
                }
                
                const tests = [
                    {
                        name: 'è¿”å›å¯¹è±¡',
                        Constructor: ReturnObject,
                        expectExternal: true
                    },
                    {
                        name: 'è¿”å›åŸºæœ¬ç±»å‹',
                        Constructor: ReturnPrimitive,
                        expectExternal: false
                    },
                    {
                        name: 'æ— è¿”å›å€¼',
                        Constructor: NoReturn,
                        expectExternal: false
                    }
                ];
                
                result.textContent = `ğŸ”„ è¿”å›å€¼å¤„ç†æµ‹è¯•:\n\n`;
                
                tests.forEach(test => {
                    const native = new test.Constructor();
                    const my = myNew(test.Constructor);
                    
                    result.textContent += `ğŸ“‹ ${test.name}:\n`;
                    result.textContent += `  åŸç”Ÿ: ${JSON.stringify(native)}\n`;
                    result.textContent += `  myNew: ${JSON.stringify(my)}\n`;
                    
                    const nativeExternal = native.name === 'external';
                    const myExternal = my.name === 'external';
                    const consistent = nativeExternal === myExternal;
                    
                    result.textContent += `  è¡Œä¸ºä¸€è‡´: ${consistent ? 'âœ…' : 'âŒ'}\n\n`;
                });
                
            } catch (error) {
                result.textContent = `âŒ è¿”å›å€¼æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•ç®­å¤´å‡½æ•°
        function testArrowFunction() {
            const result = document.getElementById('new-result');
            
            try {
                const ArrowFunction = (name) => {
                    this.name = name;
                };
                
                result.textContent = `ğŸ¹ ç®­å¤´å‡½æ•°æµ‹è¯•:\n\n`;
                
                // æµ‹è¯•åŸç”Ÿ new (åº”è¯¥æŠ¥é”™)
                try {
                    const native = new ArrowFunction('test');
                    result.textContent += `âŒ åŸç”Ÿ new ç®­å¤´å‡½æ•°: æœªæŠ¥é”™ (å¼‚å¸¸)\n`;
                } catch (error) {
                    result.textContent += `âœ… åŸç”Ÿ new ç®­å¤´å‡½æ•°: ${error.name}\n`;
                }
                
                // æµ‹è¯• myNew (åº”è¯¥æŠ¥é”™)
                try {
                    const my = myNew(ArrowFunction, 'test');
                    result.textContent += `âŒ myNew ç®­å¤´å‡½æ•°: æœªæŠ¥é”™ (å¼‚å¸¸)\n`;
                } catch (error) {
                    result.textContent += `âœ… myNew ç®­å¤´å‡½æ•°: ${error.message}\n`;
                }
                
                result.textContent += `\nğŸ’¡ ç®­å¤´å‡½æ•°æ²¡æœ‰ prototype å±æ€§ï¼Œä¸èƒ½ä½œä¸ºæ„é€ å‡½æ•°ä½¿ç”¨`;
                
            } catch (error) {
                result.textContent = `âŒ ç®­å¤´å‡½æ•°æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•åŸºç¡€ instanceof
        function testBasicInstanceof() {
            const result = document.getElementById('instanceof-result');
            const visualization = document.getElementById('prototype-visualization');
            
            try {
                const person = new Person('John', 25);
                const student = new Student('Jane', 20, 'MIT');
                const arr = [1, 2, 3];
                const obj = {};
                
                const tests = [
                    { obj: person, Constructor: Person, expected: true },
                    { obj: person, Constructor: Object, expected: true },
                    { obj: student, Constructor: Student, expected: true },
                    { obj: student, Constructor: Person, expected: true },
                    { obj: student, Constructor: Object, expected: true },
                    { obj: arr, Constructor: Array, expected: true },
                    { obj: arr, Constructor: Object, expected: true },
                    { obj: obj, Constructor: Object, expected: true },
                    { obj: person, Constructor: Array, expected: false },
                    { obj: arr, Constructor: Person, expected: false }
                ];
                
                result.textContent = `ğŸ” åŸºç¡€ instanceof æµ‹è¯•:\n\n`;
                
                let allPassed = true;
                tests.forEach((test, index) => {
                    const native = test.obj instanceof test.Constructor;
                    const my = myInstanceof(test.obj, test.Constructor);
                    
                    const passed = native === my && native === test.expected;
                    allPassed = allPassed && passed;
                    
                    result.textContent += `${passed ? 'âœ…' : 'âŒ'} æµ‹è¯•${index + 1}: `;
                    result.textContent += `${getObjectName(test.obj)} instanceof ${test.Constructor.name}\n`;
                    result.textContent += `   åŸç”Ÿ: ${native}, myInstanceof: ${my}, æœŸæœ›: ${test.expected}\n`;
                });
                
                result.textContent += `\nğŸ¯ æ€»ä½“ç»“æœ: ${allPassed ? 'âœ… å…¨éƒ¨é€šè¿‡' : 'âŒ å­˜åœ¨é—®é¢˜'}`;
                
                // æ˜¾ç¤ºåŸå‹é“¾
                showPrototypeChain(student, 'chain-items');
                visualization.style.display = 'block';
                
            } catch (error) {
                result.textContent = `âŒ åŸºç¡€ instanceof æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // è·å–å¯¹è±¡åç§°
        function getObjectName(obj) {
            if (Array.isArray(obj)) return 'Array';
            if (obj.constructor && obj.constructor.name) return obj.constructor.name + 'å®ä¾‹';
            return 'Object';
        }
        
        // æ˜¾ç¤ºåŸå‹é“¾
        function showPrototypeChain(obj, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            let current = obj;
            let level = 0;
            
            while (current && level < 10) {
                const item = document.createElement('div');
                item.className = 'chain-item';
                
                let name = '';
                if (level === 0) {
                    name = `å¯¹è±¡å®ä¾‹ (${obj.constructor.name})`;
                } else if (current.constructor) {
                    name = `${current.constructor.name}.prototype`;
                } else {
                    name = 'Object.prototype / null';
                }
                
                item.textContent = `${level}: ${name}`;
                container.appendChild(item);
                
                current = Object.getPrototypeOf(current);
                level++;
            }
        }
        
        // æµ‹è¯•ç»§æ‰¿é“¾
        function testInheritanceChain() {
            const result = document.getElementById('instanceof-result');
            
            try {
                // åˆ›å»ºå¤šå±‚ç»§æ‰¿
                function Animal(name) {
                    this.name = name;
                }
                
                function Mammal(name, furColor) {
                    Animal.call(this, name);
                    this.furColor = furColor;
                }
                Mammal.prototype = Object.create(Animal.prototype);
                Mammal.prototype.constructor = Mammal;
                
                function Dog(name, furColor, breed) {
                    Mammal.call(this, name, furColor);
                    this.breed = breed;
                }
                Dog.prototype = Object.create(Mammal.prototype);
                Dog.prototype.constructor = Dog;
                
                const dog = new Dog('Buddy', 'brown', 'Golden Retriever');
                
                const tests = [
                    { Constructor: Dog, expected: true },
                    { Constructor: Mammal, expected: true },
                    { Constructor: Animal, expected: true },
                    { Constructor: Object, expected: true },
                    { Constructor: Array, expected: false },
                    { Constructor: Function, expected: false }
                ];
                
                result.textContent = `ğŸ§¬ ç»§æ‰¿é“¾æµ‹è¯• (Dog â†’ Mammal â†’ Animal â†’ Object):\n\n`;
                
                tests.forEach(test => {
                    const native = dog instanceof test.Constructor;
                    const my = myInstanceof(dog, test.Constructor);
                    const passed = native === my;
                    
                    result.textContent += `${passed ? 'âœ…' : 'âŒ'} dog instanceof ${test.Constructor.name}: `;
                    result.textContent += `åŸç”Ÿ=${native}, my=${my}\n`;
                });
                
                result.textContent += `\nğŸ¯ Dogå®ä¾‹å±æ€§:\n`;
                result.textContent += `  name: ${dog.name}\n`;
                result.textContent += `  furColor: ${dog.furColor}\n`;
                result.textContent += `  breed: ${dog.breed}\n`;
                result.textContent += `  constructor: ${dog.constructor.name}`;
                
            } catch (error) {
                result.textContent = `âŒ ç»§æ‰¿é“¾æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•åŸºæœ¬ç±»å‹
        function testPrimitiveTypes() {
            const result = document.getElementById('instanceof-result');
            
            try {
                const primitives = [
                    { value: 42, name: 'number' },
                    { value: 'hello', name: 'string' },
                    { value: true, name: 'boolean' },
                    { value: null, name: 'null' },
                    { value: undefined, name: 'undefined' },
                    { value: Symbol('test'), name: 'symbol' }
                ];
                
                result.textContent = `ğŸ¯ åŸºæœ¬ç±»å‹æµ‹è¯•:\n\n`;
                
                primitives.forEach(primitive => {
                    try {
                        const native = primitive.value instanceof Object;
                        const my = myInstanceof(primitive.value, Object);
                        const passed = native === my;
                        
                        result.textContent += `${passed ? 'âœ…' : 'âŒ'} ${primitive.name} instanceof Object: `;
                        result.textContent += `åŸç”Ÿ=${native}, my=${my}\n`;
                    } catch (error) {
                        result.textContent += `âš ï¸ ${primitive.name}: ${error.message}\n`;
                    }
                });
                
                result.textContent += `\nğŸ’¡ åŸºæœ¬ç±»å‹ä¸æ˜¯å¯¹è±¡ï¼Œinstanceof åº”è¯¥è¿”å› false`;
                
            } catch (error) {
                result.textContent = `âŒ åŸºæœ¬ç±»å‹æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•Symbol.hasInstance
        function testSymbolHasInstance() {
            const result = document.getElementById('instanceof-result');
            
            try {
                // åˆ›å»ºè‡ªå®šä¹‰instanceofè¡Œä¸º
                class CustomClass {
                    static [Symbol.hasInstance](instance) {
                        return instance && instance.customFlag === true;
                    }
                }
                
                const obj1 = { customFlag: true };
                const obj2 = { customFlag: false };
                const obj3 = new CustomClass();
                
                result.textContent = `ğŸ”® Symbol.hasInstance æµ‹è¯•:\n\n`;
                
                const tests = [
                    { obj: obj1, expected: true, name: 'customFlag=trueçš„å¯¹è±¡' },
                    { obj: obj2, expected: false, name: 'customFlag=falseçš„å¯¹è±¡' },
                    { obj: obj3, expected: false, name: 'CustomClasså®ä¾‹' }
                ];
                
                tests.forEach(test => {
                    try {
                        const native = test.obj instanceof CustomClass;
                        const my = myInstanceofWithSymbol ? myInstanceofWithSymbol(test.obj, CustomClass) : 'ä¸æ”¯æŒ';
                        
                        result.textContent += `ğŸ“‹ ${test.name}:\n`;
                        result.textContent += `   åŸç”Ÿ: ${native}\n`;
                        result.textContent += `   my: ${my}\n`;
                        result.textContent += `   æœŸæœ›: ${test.expected}\n`;
                        result.textContent += `   åŒ¹é…: ${native === test.expected ? 'âœ…' : 'âŒ'}\n\n`;
                    } catch (error) {
                        result.textContent += `âŒ ${test.name}: ${error.message}\n`;
                    }
                });
                
            } catch (error) {
                result.textContent = `âŒ Symbol.hasInstance æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•å¤æ‚åœºæ™¯
        function testComplexScenario() {
            const result = document.getElementById('complex-result');
            
            try {
                // ä½¿ç”¨ myNew åˆ›å»ºå¯¹è±¡ï¼Œç„¶åç”¨ myInstanceof æ£€æµ‹
                const person = myNew(Person, 'Complex', 30);
                const student = myNew(Student, 'Advanced', 22, 'Harvard');
                
                result.textContent = `ğŸ¯ ç»¼åˆåº”ç”¨æµ‹è¯•:\n\n`;
                
                result.textContent += `ğŸ“‹ ä½¿ç”¨ myNew åˆ›å»ºçš„å¯¹è±¡:\n`;
                result.textContent += `Person: ${person.greet()}\n`;
                result.textContent += `Student: ${student.study()}\n\n`;
                
                result.textContent += `ğŸ” ä½¿ç”¨ myInstanceof æ£€æµ‹:\n`;
                result.textContent += `person instanceof Person: ${myInstanceof(person, Person)}\n`;
                result.textContent += `person instanceof Object: ${myInstanceof(person, Object)}\n`;
                result.textContent += `student instanceof Student: ${myInstanceof(student, Student)}\n`;
                result.textContent += `student instanceof Person: ${myInstanceof(student, Person)}\n`;
                result.textContent += `student instanceof Object: ${myInstanceof(student, Object)}\n\n`;
                
                // ä¿®æ”¹åŸå‹é“¾æµ‹è¯•
                const originalProto = Student.prototype;
                Student.prototype = {};
                
                result.textContent += `ğŸ”§ ä¿®æ”¹åŸå‹é“¾å:\n`;
                result.textContent += `student instanceof Student: ${myInstanceof(student, Student)}\n`;
                result.textContent += `student instanceof Person: ${myInstanceof(student, Person)}\n`;
                
                // æ¢å¤åŸå‹é“¾
                Student.prototype = originalProto;
                
                result.textContent += `\nâœ… ç»¼åˆæµ‹è¯•å®Œæˆ`;
                
            } catch (error) {
                result.textContent = `âŒ ç»¼åˆæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•ç±»ç»§æ‰¿
        function testClassInheritance() {
            const result = document.getElementById('complex-result');
            
            try {
                // ES6 ç±»ç»§æ‰¿
                class Vehicle {
                    constructor(brand) {
                        this.brand = brand;
                    }
                    
                    start() {
                        return `${this.brand} vehicle started`;
                    }
                }
                
                class Car extends Vehicle {
                    constructor(brand, model) {
                        super(brand);
                        this.model = model;
                    }
                    
                    drive() {
                        return `Driving ${this.brand} ${this.model}`;
                    }
                }
                
                const car1 = new Car('Toyota', 'Camry');
                const car2 = myNew(Car, 'Honda', 'Civic');
                
                result.textContent = `ğŸš— ES6 ç±»ç»§æ‰¿æµ‹è¯•:\n\n`;
                
                result.textContent += `åŸç”Ÿæ„é€ :\n`;
                result.textContent += `  ${car1.start()}\n`;
                result.textContent += `  ${car1.drive()}\n`;
                result.textContent += `  car1 instanceof Car: ${car1 instanceof Car}\n`;
                result.textContent += `  car1 instanceof Vehicle: ${car1 instanceof Vehicle}\n\n`;
                
                result.textContent += `myNewæ„é€ :\n`;
                result.textContent += `  ${car2.start()}\n`;
                result.textContent += `  ${car2.drive()}\n`;
                result.textContent += `  car2 instanceof Car: ${myInstanceof(car2, Car)}\n`;
                result.textContent += `  car2 instanceof Vehicle: ${myInstanceof(car2, Vehicle)}\n`;
                
            } catch (error) {
                result.textContent = `âŒ ç±»ç»§æ‰¿æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•æ··å…¥æ¨¡å¼
        function testMixinPattern() {
            const result = document.getElementById('complex-result');
            
            try {
                // æ··å…¥åŠŸèƒ½
                const CanFly = {
                    fly() { return `${this.name} is flying`; }
                };
                
                const CanSwim = {
                    swim() { return `${this.name} is swimming`; }
                };
                
                function Bird(name) {
                    this.name = name;
                }
                
                // æ··å…¥åŠŸèƒ½
                Object.assign(Bird.prototype, CanFly);
                
                function Duck(name) {
                    Bird.call(this, name);
                }
                
                Duck.prototype = Object.create(Bird.prototype);
                Duck.prototype.constructor = Duck;
                Object.assign(Duck.prototype, CanSwim);
                
                const duck = myNew(Duck, 'Donald');
                
                result.textContent = `ğŸ¦† æ··å…¥æ¨¡å¼æµ‹è¯•:\n\n`;
                result.textContent += `Duckå®ä¾‹åŠŸèƒ½:\n`;
                result.textContent += `  name: ${duck.name}\n`;
                result.textContent += `  fly(): ${duck.fly()}\n`;
                result.textContent += `  swim(): ${duck.swim()}\n\n`;
                
                result.textContent += `instanceofæ£€æµ‹:\n`;
                result.textContent += `  duck instanceof Duck: ${myInstanceof(duck, Duck)}\n`;
                result.textContent += `  duck instanceof Bird: ${myInstanceof(duck, Bird)}\n`;
                result.textContent += `  duck instanceof Object: ${myInstanceof(duck, Object)}\n`;
                
            } catch (error) {
                result.textContent = `âŒ æ··å…¥æ¨¡å¼æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ€§èƒ½æµ‹è¯•
        function runPerformanceTest() {
            const result = document.getElementById('performance-result');
            
            result.textContent = 'å¼€å§‹æ€§èƒ½æµ‹è¯•...\n';
            
            const iterations = 100000;
            const obj = new Person('Test', 25);
            
            // æµ‹è¯• instanceof æ€§èƒ½
            const nativeStart = performance.now();
            for (let i = 0; i < iterations; i++) {
                obj instanceof Person;
                obj instanceof Object;
            }
            const nativeTime = performance.now() - nativeStart;
            
            // æµ‹è¯• myInstanceof æ€§èƒ½
            const myStart = performance.now();
            for (let i = 0; i < iterations; i++) {
                myInstanceof(obj, Person);
                myInstanceof(obj, Object);
            }
            const myTime = performance.now() - myStart;
            
            // æµ‹è¯• new æ€§èƒ½
            const nativeNewStart = performance.now();
            for (let i = 0; i < 10000; i++) {
                new Person('Test', i);
            }
            const nativeNewTime = performance.now() - nativeNewStart;
            
            const myNewStart = performance.now();
            for (let i = 0; i < 10000; i++) {
                myNew(Person, 'Test', i);
            }
            const myNewTime = performance.now() - myNewStart;
            
            result.textContent = `âš¡ æ€§èƒ½æµ‹è¯•ç»“æœ:\n\n`;
            result.textContent += `instanceof (${iterations * 2} æ¬¡):\n`;
            result.textContent += `  åŸç”Ÿ: ${Math.round(nativeTime)}ms\n`;
            result.textContent += `  myInstanceof: ${Math.round(myTime)}ms\n`;
            result.textContent += `  æ€§èƒ½æ¯”: ${Math.round(myTime / nativeTime * 100)}%\n\n`;
            
            result.textContent += `new (10000 æ¬¡):\n`;
            result.textContent += `  åŸç”Ÿ: ${Math.round(nativeNewTime)}ms\n`;
            result.textContent += `  myNew: ${Math.round(myNewTime)}ms\n`;
            result.textContent += `  æ€§èƒ½æ¯”: ${Math.round(myNewTime / nativeNewTime * 100)}%\n\n`;
            
            result.textContent += `ğŸ’¡ åˆ†æ:\n`;
            result.textContent += `- è‡ªå®ç°ç‰ˆæœ¬ç•¥æ…¢äºåŸç”Ÿå®ç°\n`;
            result.textContent += `- æ€§èƒ½å·®å¼‚ä¸»è¦æ¥è‡ªé¢å¤–çš„ç±»å‹æ£€æŸ¥\n`;
            result.textContent += `- åœ¨å®é™…åº”ç”¨ä¸­å·®å¼‚å¯å¿½ç•¥ä¸è®¡`;
        }
        
        // è¾¹ç•Œæƒ…å†µæµ‹è¯•
        function testEdgeCases() {
            const result = document.getElementById('performance-result');
            
            result.textContent = 'ğŸ§ª è¾¹ç•Œæƒ…å†µæµ‹è¯•:\n\n';
            
            const edgeCases = [
                {
                    name: 'nullå¯¹è±¡',
                    test: () => myInstanceof(null, Object),
                    expected: false
                },
                {
                    name: 'undefinedå¯¹è±¡',
                    test: () => myInstanceof(undefined, Object),
                    expected: false
                },
                {
                    name: 'ç©ºæ„é€ å‡½æ•°',
                    test: () => {
                        function Empty() {}
                        const obj = myNew(Empty);
                        return myInstanceof(obj, Empty);
                    },
                    expected: true
                },
                {
                    name: 'æ— prototypeçš„å‡½æ•°',
                    test: () => {
                        function NoProto() {}
                        delete NoProto.prototype;
                        try {
                            return myNew(NoProto);
                        } catch (e) {
                            return 'error';
                        }
                    },
                    expected: 'error'
                }
            ];
            
            edgeCases.forEach(testCase => {
                try {
                    const actual = testCase.test();
                    const passed = actual === testCase.expected;
                    result.textContent += `${passed ? 'âœ…' : 'âŒ'} ${testCase.name}: `;
                    result.textContent += `æœŸæœ›=${testCase.expected}, å®é™…=${actual}\n`;
                } catch (error) {
                    result.textContent += `âš ï¸ ${testCase.name}: ${error.message}\n`;
                }
            });
            
            result.textContent += '\nâœ… è¾¹ç•Œæƒ…å†µæµ‹è¯•å®Œæˆ';
        }
        
        // é”™è¯¯å¤„ç†æµ‹è¯•
        function testErrorHandling() {
            const result = document.getElementById('performance-result');
            
            result.textContent = 'ğŸš¨ é”™è¯¯å¤„ç†æµ‹è¯•:\n\n';
            
            const errorTests = [
                {
                    name: 'éå‡½æ•°æ„é€ å™¨(myNew)',
                    test: () => myNew('not a function'),
                    shouldThrow: true
                },
                {
                    name: 'éå‡½æ•°æ„é€ å™¨(myInstanceof)',
                    test: () => myInstanceof({}, 'not a function'),
                    shouldThrow: true
                },
                {
                    name: 'æ­£å¸¸çš„é”™è¯¯æ„é€ å‡½æ•°',
                    test: () => {
                        function ErrorConstructor() {
                            throw new Error('æ„é€ å‡½æ•°å†…éƒ¨é”™è¯¯');
                        }
                        return myNew(ErrorConstructor);
                    },
                    shouldThrow: true
                }
            ];
            
            errorTests.forEach(test => {
                try {
                    const result = test.test();
                    if (test.shouldThrow) {
                        result.textContent += `âŒ ${test.name}: åº”è¯¥æŠ›å‡ºé”™è¯¯ä½†æ²¡æœ‰\n`;
                    } else {
                        result.textContent += `âœ… ${test.name}: æ­£å¸¸æ‰§è¡Œ\n`;
                    }
                } catch (error) {
                    if (test.shouldThrow) {
                        result.textContent += `âœ… ${test.name}: æ­£ç¡®æŠ›å‡ºé”™è¯¯ - ${error.message}\n`;
                    } else {
                        result.textContent += `âŒ ${test.name}: ä¸åº”è¯¥æŠ›å‡ºé”™è¯¯ - ${error.message}\n`;
                    }
                }
            });
            
            result.textContent += '\nâœ… é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ';
        }
        
        // é¡µé¢åŠ è½½æç¤º
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ—ï¸ New/Instanceofæ¼”ç¤ºé¡µé¢å·²åŠ è½½');
            console.log('ğŸ’¡ ç‚¹å‡»æµ‹è¯•æŒ‰é’®æŸ¥çœ‹å„ç§å®ç°æ•ˆæœ');
            
            // æ·»åŠ è¯´æ˜
            document.querySelector('.demo-container').insertAdjacentHTML('afterbegin', `
                <div class="highlight">
                    <strong>ğŸ’¡ æ¼”ç¤ºè¯´æ˜ï¼š</strong>
                    æœ¬æ¼”ç¤ºå±•ç¤ºäº† new æ“ä½œç¬¦å’Œ instanceof æ“ä½œç¬¦çš„å®Œæ•´å®ç°ã€‚
                    åŒ…æ‹¬åŸå‹é“¾å¤„ç†ã€ç»§æ‰¿å…³ç³»æ£€æµ‹ã€è¾¹ç•Œæƒ…å†µå¤„ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚
                </div>
            `);
        });
    </script>
</body>
</html>
